name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Setup Environment (Load Node.js)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            # 2. Navigate to Project
            cd ~/cicd-pipline

            # 3. ğŸš¨ FIX: Force Sync with GitHub 
            # (Discards manual server edits that were causing the 'Aborting' error)
            git fetch --all
            git reset --hard origin/main
            
            # 4. Install Dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install

            # 5. Clean & Rebuild Database
            echo "ğŸ—„ï¸ Rebuilding Database..."
            cd packages/db
            npx tsc -b --clean
            npx prisma generate
            npx tsc -b
            cd ../..

            # 6. Clean & Rebuild Web App
            echo "ğŸŒ Rebuilding Next.js Web App..."
            cd apps/web
            rm -rf .next
            cd ../..

            # 7. Global Build
            echo "ğŸ—ï¸ Running Global Build..."
            npm run build

            # 8. Restart PM2 Services
            echo "ğŸš€ Restarting Servers..."
            pm2 restart https-server
            pm2 restart websocket
            pm2 restart web-server

            echo "âœ… Deployment Complete!"